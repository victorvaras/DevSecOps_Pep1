<?xml version="1.0" encoding="UTF-8"?>
<ruleset name="React Security Best Practices"
         xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd">

    <description>Reglas de seguridad y mejores prácticas para ReactJS/NodeJS (PMD 7.12+)</description>

    <!-- ================================= -->
    <!-- 1. Reglas de Seguridad ReactJS    -->
    <!-- ================================= -->
    <rule name="AvoidDangerouslySetInnerHTML"
          language="jsx"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="[SEC-01] Uso de dangerouslySetInnerHTML sin sanitización">
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    //JSXAttribute[@Name='dangerouslySetInnerHTML']
                    [not(ancestor::CallExpression/Callee/Name='sanitizeHTML')]
                ]]></value>
            </property>
        </properties>
        <example>
            <![CDATA[
            // ❌ Incorrecto
            <div dangerouslySetInnerHTML={{__html: userContent}} />

            // ✅ Correcto
            <div dangerouslySetInnerHTML={{__html: sanitizeHTML(userContent)}} />
            ]]>
        </example>
    </rule>

    <rule name="SecureReactRouterNavigation"
          language="jsx"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="[SEC-02] Navegación no segura con React Router">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    //Literal[matches(@Image,'^http://')]
                ]]></value>
            </property>
        </properties>
    </rule>

    <!-- ================================= -->
    <!-- 2. Mejores Prácticas ReactJS      -->
    <!-- ================================= -->
    <rule name="ComponentPropTypesValidation"
          language="js"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="[BP-01] Componente sin validación de PropTypes">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    //FunctionDeclaration[matches(@Image,'^[A-Z]')]
                    [not(//MemberExpression[@PropertyName='propTypes'])]
                ]]></value>
            </property>
        </properties>
    </rule>

    <rule name="HookUsageOrder"
          language="js"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="[BP-02] Los Hooks deben ser usados en orden consistente">
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    //CallExpression[matches(@Image,'^use[A-Z]')]
                    [not(ancestor::FunctionDeclaration)]
                ]]></value>
            </property>
        </properties>
    </rule>

    <!-- ================================= -->
    <!-- 3. Reglas de Performance          -->
    <!-- ================================= -->
    <rule name="AvoidInlineFunctionsInRender"
          language="jsx"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="[PERF-01] Evitar funciones inline en renderizado">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    //JSXAttribute[matches(@Name,'^on[A-Z]')]
                    /AttributeValue/ArrowFunctionExpression
                ]]></value>
            </property>
        </properties>
    </rule>

    <rule name="OptimizeReRenders"
          language="jsx"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="[PERF-02] Componente sin React.memo o shouldComponentUpdate">
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    //FunctionDeclaration[matches(@Image,'^[A-Z]')]
                    [not(ancestor::CallExpression/Callee/Identifier/@Name='memo')]
                ]]></value>
            </property>
        </properties>
    </rule>

    <!-- ================================= -->
    <!-- 4. Reglas de Estructura           -->
    <!-- ================================= -->
    <rule name="ComponentFileStructure"
          language="js"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="[STR-01] Archivo debe contener solo un componente principal">
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
                    count(//FunctionDeclaration[matches(@Image,'^[A-Z]')]) > 1
                ]]></value>
            </property>
        </properties>
    </rule>

</ruleset>